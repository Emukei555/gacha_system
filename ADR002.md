# ADR-002: Gemsの有償優先消費ロジック

## ステータス
Accepted

## 日付
- 提案日: 2026-1-17
- 決定日: 2026-1-17

## コンテキスト
本システムでは、ユーザーが保有する通貨（Gems）を「有償石（Paid Stones）」と「無償石（Free Stones）」の2種類に区別して管理しています。これは日本の資金決済法（Payment Services Act）における「前払式支払手段」として、有償分の未使用残高を正確に把握し、供託金を管理する必要があるためです。

ユーザーがガチャやアイテム購入で石を消費する際、どちらの石から先に減算するかという「消費優先順位」をシステムレベルで統一的に定義する必要があります。このルールが曖昧だと、将来的な「有償限定ガチャ」の実装時や、返金対応時の計算ロジックに不整合が生じるリスクがあります。

## 検討した選択肢

### 選択肢1: 有償石を優先消費（Paid First）
- **メリット**:
    - 企業側の財務リスク低減（負債となる有償残高を早期に消化できる）。
    - ユーザーに「有償石を使い切る」動機づけを行い、再課金サイクルを早める効果が期待できる。
    - 実装がシンプル（無償石はあくまで「不足分の補填」という位置付けでロジックが組める）。
- **デメリット**:
    - ユーザー心理として「貴重な有償石を取っておきたい」という要望に反する場合があり、不満要因になり得る。
- **トレードオフ**: ユーザー体験（保存欲求） vs 財務健全性・実装の明確さ

### 選択肢2: 無償石を優先消費（Free First）
- **メリット**:
    - 多くのソーシャルゲームで採用されており、ユーザーにとって馴染み深い（貴重な石を温存できる）。
    - ユーザー満足度が高くなりやすい。
- **デメリット**:
    - 有償残高が長く滞留するため、供託金の管理コストや財務上の負債リスクが高まる。
    - 「有償限定ガチャ」を引くために有償石を残したいユーザーにとってはメリットだが、システム全体の資金循環は鈍化する可能性がある。
- **トレードオフ**: ユーザー満足度 vs 財務リスク

### 選択肢3: ユーザーが選択可能（Configurable）
- **メリット**:
    - ユーザーの好みに合わせられるため、最も柔軟性が高い。
- **デメリット**:
    - 消費ロジックが複雑化し、不変条件（Invariant）のテストケースが倍増する。
    - UI/UXが煩雑になる。
- **トレードオフ**: 柔軟性 vs 実装コスト・保守性

## 決定したもの
**選択肢1: 有償石を優先消費（Paid First）を採用**

## 決定の理由
本プロジェクトでは、「財務健全性」と「ロジックの堅牢性」を最優先事項としました。

1.  **財務リスクの最小化**: 未使用の有償残高は法的・財務的な負債となるため、これを早期に償却するロジックを採用することで、事業運営のリスクを低減します。
2.  **ドメインロジックの一貫性**: `Wallet` 集約内で「有償石を主体とし、無償石を補助とする」という明確な主従関係を定義することで、消費ロジックの複雑さを排除しました。
3.  **変更容易性**: ロジックは `Wallet.java` の `consume` メソッド内に完全にカプセル化されているため、将来的に方針転換（無償優先へ変更）が必要になった場合でも、影響範囲をこの1メソッドに限定できます。

## 影響範囲・副作用
- **影響を受けるクラス**: `Wallet`
- **影響を受けるユースケース**: ガチャ実行、アイテム購入などの全消費アクション
- **副作用**:
    - ログ出力において、`paidStones` と `freeStones` の減少内訳を常に明確に記録する必要がある（`Wallet.java` で実装済み）。
- **ユーザーへの影響**:
    - ヘルプや規約等で「有償石から先に消費される」旨を明記する必要がある。

## 関連ADR
- ADR-001: Resultパターンの基盤採用（消費時のエラーハンドリングに関連）
- ADR-003: 不変条件のDB制約併用（残高が負にならない保証）

## 参考資料
- 資金決済法（Payment Services Act）ガイドライン
- `Wallet.java` の実装コード（`consume` メソッド）